# Cube 服务端技术文档

## 文档说明

本文档是 Cube 项目服务端的完整技术文档，包含架构设计、开发指南、API 文档等核心内容。

**文档版本**：1.0  
**最后更新**：2026-01-22  
**维护团队**：服务端技术团队

---

## 目录

1. [架构设计](#1-架构设计)
2. [HTTP Server 详细设计](#2-http-server-详细设计)
3. [TCP Server 详细设计](#3-tcp-server-详细设计)
4. [数据库设计](#4-数据库设计)
5. [网络协议](#5-网络协议)
6. [部署运维](#6-部署运维)
7. [开发指南](#7-开发指南)

---

## 1. 架构设计

### 1.1 整体架构

Cube 服务端采用**双服务器架构**，分别处理不同类型的业务：

```
客户端
  ↓
  ├── HTTP Server（ASP.NET Core）
  │   ├── 用户认证
  │   ├── 商城购买
  │   ├── 公告查询
  │   └── 数据统计
  │
  └── TCP Server（自定义游戏服务器）
      ├── 位移同步
      ├── 战斗逻辑
      ├── 房间管理
      └── 状态同步

数据库层
  ├── PostgreSQL（关系数据）
  ├── Redis（缓存/会话）
  └── MongoDB（日志/记录）
```

### 1.2 技术栈

| 组件 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| 开发框架 | .NET | 8.0 LTS | 服务端开发 |
| HTTP 框架 | ASP.NET Core | 8.0 | Web API 服务 |
| TCP 框架 | 自研 | - | 游戏服务器 |
| 主数据库 | PostgreSQL | 14+ | 关系数据存储 |
| 缓存 | Redis | 6+ | 会话/排行榜 |
| 文档数据库 | MongoDB | 5+ | 日志/记录 |
| ORM | Entity Framework Core | 8.0 | 数据访问 |
| 序列化 | Protobuf | 3.x | 消息序列化 |
| 日志 | Serilog | 3.x | 日志记录 |

### 1.3 服务职责划分

#### HTTP Server 职责
- ✅ 用户认证（登录、注册、Token 验证）
- ✅ 商城系统（商品查询、购买）
- ✅ 用户管理（个人信息、背包、角色）
- ✅ 公告系统（公告发布、查询）
- ✅ 数据统计（用户数据、游戏统计）
- ✅ 非实时业务处理

#### TCP Server 职责
- ✅ 游戏连接管理（连接、认证、心跳）
- ✅ 房间管理（创建、加入、离开）
- ✅ 匹配系统（匹配队列、ELO 评分）
- ✅ 游戏逻辑（位移、战斗、状态同步）
- ✅ 实时数据同步（位置、HP、技能状态）

### 1.4 服务间通信

HTTP Server 与 TCP Server 通过以下方式通信：

1. **共享数据库**：PostgreSQL、Redis
2. **消息队列**：Redis Pub/Sub（可选）
3. **事件驱动**：通过数据库状态变化触发

**通信场景示例**：
- 用户登录后，HTTP Server 在 Redis 中标记用户在线，TCP Server 监听并建立会话
- 用户购买道具后，HTTP Server 更新数据库，TCP Server 通过轮询或事件推送道具

---

## 2. HTTP Server 详细设计

### 2.1 项目结构

```
httpserver/
├── Controllers/          # API 控制器
│   ├── AuthController.cs
│   ├── TradeController.cs
│   └── ...
├── Services/            # 业务逻辑层
│   ├── AuthService.cs
│   ├── ShopService.cs
│   └── ...
├── Repositories/        # 数据访问层
│   ├── UserRepository.cs
│   └── ...
├── Models/              # 数据模型
│   ├── User.cs
│   └── ...
├── Middlewares/         # 中间件
│   ├── JwtMiddleware.cs
│   └── ...
├── Program.cs           # 程序入口
└── appsettings.json     # 配置文件
```

### 2.2 认证系统

#### 2.2.1 功能模块

- **用户注册**：用户名、邮箱、密码注册
- **用户登录**：用户名/邮箱 + 密码登录
- **Token 刷新**：Refresh Token 机制
- **密码找回**：邮箱验证重置密码
- **第三方登录**：OAuth 2.0（可选）

#### 2.2.2 API 接口

```csharp
// 注册
POST /api/auth/register
Request: {
    "username": "string",
    "email": "string",
    "password": "string"
}

// 登录
POST /api/auth/login
Request: {
    "username": "string",
    "password": "string"
}
Response: {
    "accessToken": "string",
    "refreshToken": "string",
    "expiresIn": 3600
}

// 刷新 Token
POST /api/auth/refresh
Request: {
    "refreshToken": "string"
}

// 登出
POST /api/auth/logout
Headers: Authorization: Bearer {token}
```

#### 2.2.3 JWT Token 设计

```csharp
// Access Token Payload
{
    "sub": "user_id",
    "name": "username",
    "role": "player",
    "exp": 1234567890,  // 1小时过期
    "iat": 1234567890
}

// Refresh Token Payload
{
    "sub": "user_id",
    "tokenId": "guid",
    "exp": 1234567890,  // 30天过期
    "iat": 1234567890
}
```

#### 2.2.4 安全措施

- **密码加密**：BCrypt 哈希，Salt 随机生成
- **Token 过期**：Access Token 1小时，Refresh Token 30天
- **防暴力破解**：登录失败限流（5次/分钟）
- **IP 白名单**：管理接口仅允许特定 IP

### 2.3 商城系统

#### 2.3.1 数据模型

```csharp
public class ShopItem
{
    public int ItemId { get; set; }           // 商品ID
    public string Name { get; set; }           // 商品名称
    public string Description { get; set; }     // 描述
    public int Price { get; set; }              // 价格
    public string Currency { get; set; }        // 货币类型（金币/钻石）
    public int Stock { get; set; }               // 库存（-1为无限）
    public DateTime StartTime { get; set; }     // 上架时间
    public DateTime EndTime { get; set; }       // 下架时间
    public string Category { get; set; }        // 分类
    public string IconUrl { get; set; }         // 图标URL
}
```

#### 2.3.2 API 接口

```csharp
// 获取商品列表
GET /api/shop/items?category={category}&page={page}&pageSize={size}

// 获取商品详情
GET /api/shop/items/{id}

// 获取分类列表
GET /api/shop/categories

// 获取推荐商品
GET /api/shop/recommend

// 获取热门商品
GET /api/shop/hot
```

### 2.4 购买系统

#### 2.4.1 购买流程

```
1. 客户端请求购买
   ↓
2. 服务端验证：
   - 商品是否存在
   - 库存是否充足
   - 用户余额是否足够
   ↓
3. 创建订单（待支付）
   ↓
4. 扣除虚拟货币/调用支付接口
   ↓
5. 发放道具到用户背包
   ↓
6. 更新订单状态（已完成）
   ↓
7. 通知客户端
```

#### 2.4.2 订单状态机

```
待支付 → 支付中 → 已支付 → 已发货 → 已完成
   ↓       ↓
已取消   已退款
```

#### 2.4.3 事务处理

- **数据库事务**：保证原子性
- **分布式锁**：Redis 锁防止超卖
- **幂等性设计**：订单号唯一，防止重复扣款

### 2.5 统一响应格式

```json
// 成功响应
{
    "code": 200,
    "message": "success",
    "data": { },
    "timestamp": 1234567890
}

// 错误响应
{
    "code": 400,
    "message": "请求参数错误",
    "error": "详细错误信息",
    "timestamp": 1234567890
}
```

### 2.6 统一错误码

| 错误码 | 说明 | HTTP 状态码 |
|-------|------|------------|
| 200 | 成功 | 200 |
| 400 | 请求参数错误 | 400 |
| 401 | 未授权 | 401 |
| 403 | 禁止访问 | 403 |
| 404 | 资源不存在 | 404 |
| 500 | 服务器错误 | 500 |
| 1001 | 用户名已存在 | 400 |
| 1002 | 密码错误 | 401 |
| 2001 | 库存不足 | 400 |
| 2002 | 余额不足 | 400 |

---

## 3. TCP Server 详细设计

### 3.1 项目结构

```
gameserver/
├── Network/             # 网络层
│   ├── ConnectionManager.cs
│   ├── MessageHandler.cs
│   └── HeartbeatManager.cs
├── Game/                # 游戏逻辑层
│   ├── Movement/        # 位移系统
│   ├── Combat/          # 战斗系统
│   ├── Room/            # 房间系统
│   └── Match/           # 匹配系统
├── Protocol/            # 协议层
│   ├── Serialization.cs
│   └── MessageTypes.cs
├── State/               # 状态管理
│   └── StateSync.cs
├── GameRoom.cs          # 游戏房间
└── Program.cs           # 程序入口
```

### 3.2 连接管理

#### 3.2.1 连接流程

```
1. 客户端发起 TCP 连接
   ↓
2. 服务端分配连接 ID
   ↓
3. 客户端发送认证消息（包含 HTTP Token）
   ↓
4. 服务端验证 Token
   ↓
5. 建立会话，绑定用户 ID
   ↓
6. 开始心跳检测
```

#### 3.2.2 心跳机制

```csharp
// 客户端每 30 秒发送心跳
Message: { 
    Type: Heartbeat, 
    Timestamp: xxx 
}

// 服务端响应心跳
Message: { 
    Type: HeartbeatAck, 
    Timestamp: xxx 
}

// 超过 90 秒未收到心跳，断开连接
```

#### 3.2.3 连接管理器

```csharp
public class ConnectionManager
{
    private Dictionary<int, Connection> connections;
    
    public void OnConnect(Socket socket);
    public void OnAuthenticate(int connId, string token);
    public void OnDisconnect(int connId);
    public void OnHeartbeat(int connId);
    public void Broadcast(Message msg);
    public void SendTo(int userId, Message msg);
}
```

### 3.3 位移系统

#### 3.3.1 同步策略

- **客户端预测**：客户端立即响应输入
- **服务器权威**：服务器验证并广播位置
- **插值平滑**：其他客户端平滑显示
- **延迟补偿**：服务器回溯验证

#### 3.3.2 消息定义

```csharp
// 客户端 → 服务器
public class MoveRequest
{
    public int PlayerId { get; set; }
    public Vector3 TargetPosition { get; set; }
    public float Speed { get; set; }
    public long Timestamp { get; set; }
}

// 服务器 → 客户端
public class MoveSync
{
    public int PlayerId { get; set; }
    public Vector3 Position { get; set; }
    public Vector3 Velocity { get; set; }
    public long ServerTime { get; set; }
}
```

#### 3.3.3 同步频率

- 移动时：20 次/秒
- 静止时：不同步

### 3.4 战斗系统

#### 3.4.1 战斗流程

```
1. 客户端请求释放技能
   ↓
2. 服务器验证：
   - 技能是否在CD
   - 蓝量是否足够
   - 目标是否合法
   - 距离是否足够
   ↓
3. 服务器执行技能效果
   ↓
4. 计算伤害
   ↓
5. 应用伤害到目标
   ↓
6. 广播战斗事件
   ↓
7. 检查死亡
   ↓
8. 结算奖励
```

#### 3.4.2 伤害计算公式

```csharp
// 基础伤害
float baseDamage = skill.BaseDamage + attacker.Attack;

// 防御减免
float defense = target.Defense;
float damageReduction = defense / (defense + 100);
float actualDamage = baseDamage * (1 - damageReduction);

// 暴击
if (Random < attacker.CritRate)
{
    actualDamage *= attacker.CritDamage;
}

// 应用
target.HP -= actualDamage;
```

### 3.5 房间管理

#### 3.5.1 房间生命周期

```
创建 → 等待中 → 准备中 → 游戏中 → 结算中 → 销毁
```

#### 3.5.2 房间类型

- **匹配房间**：自动匹配创建
- **自建房间**：好友房，房间号加入
- **训练房间**：单人/AI 对战

#### 3.5.3 房间数据结构

```csharp
public class Room
{
    public int RoomId { get; set; }
    public string RoomName { get; set; }
    public RoomType Type { get; set; }
    public RoomState State { get; set; }
    public int MaxPlayers { get; set; }
    public List<Player> Players { get; set; }
    public RoomConfig Config { get; set; }
    public DateTime CreateTime { get; set; }
    
    public void AddPlayer(Player player);
    public void RemovePlayer(int playerId);
    public void Start();
    public void End();
}
```

### 3.6 匹配系统

#### 3.6.1 匹配算法

```
1. 玩家加入匹配队列
   ↓
2. 按评分范围查找对手
   ↓
3. 范围随等待时间扩大
   ↓
4. 匹配成功后创建房间
   ↓
5. 通知所有玩家
```

#### 3.6.2 ELO 评分系统

```csharp
// 期望胜率
float expected = 1 / (1 + Math.Pow(10, (opponentRating - playerRating) / 400));

// 评分变化
float K = 32; // K因子
float change = K * (actualScore - expected);

// 更新评分
newRating = oldRating + change;
```

---

## 4. 数据库设计

### 4.1 数据库选型

| 数据库 | 用途 | 存储内容 |
|--------|------|---------|
| PostgreSQL | 关系数据 | 用户、角色、订单、商品 |
| Redis | 缓存/会话 | Session、排行榜、在线用户 |
| MongoDB | 文档数据 | 游戏日志、战斗记录 |

### 4.2 核心表结构

#### 用户表（users）

```sql
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    salt VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    is_banned BOOLEAN DEFAULT FALSE
);
```

#### 角色表（characters）

```sql
CREATE TABLE characters (
    character_id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(user_id),
    character_name VARCHAR(50) NOT NULL,
    character_type INT NOT NULL,
    level INT DEFAULT 1,
    experience BIGINT DEFAULT 0,
    hp INT NOT NULL,
    mp INT NOT NULL,
    attack INT NOT NULL,
    defense INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_played TIMESTAMP
);
```

#### 订单表（orders）

```sql
CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(user_id),
    item_id INT NOT NULL,
    price DECIMAL(10, 2) NOT NULL,
    currency VARCHAR(10) NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    paid_at TIMESTAMP,
    completed_at TIMESTAMP
);
```

### 4.3 Redis 数据结构

#### 在线用户（Set）

```
Key: online_users
Value: Set<user_id>
TTL: 永久（定期清理）
```

#### 用户会话（String）

```
Key: session:{user_id}
Value: {token, login_time, device}
TTL: 7200 秒（2小时）
```

#### 排行榜（Sorted Set）

```
Key: leaderboard:rating
Value: ZSet<user_id, rating>
TTL: 永久
```

#### 匹配队列（List）

```
Key: match_queue:{game_mode}
Value: List<{user_id, rating, join_time}>
TTL: 600 秒（10分钟）
```

---

## 5. 网络协议

### 5.1 消息格式

```
[Header] [Body]

Header (8 bytes):
- MessageLength (4 bytes): 消息总长度
- MessageType   (2 bytes): 消息类型
- Sequence      (2 bytes): 序列号

Body:
- Protobuf 序列化的消息内容
```

### 5.2 消息类型定义

```csharp
public enum MessageType
{
    // 连接相关 (1000-1099)
    Heartbeat = 1000,
    HeartbeatAck = 1001,
    Authenticate = 1002,
    AuthenticateAck = 1003,
    
    // 房间相关 (2000-2099)
    CreateRoom = 2000,
    JoinRoom = 2001,
    LeaveRoom = 2002,
    RoomList = 2003,
    
    // 匹配相关 (2100-2199)
    StartMatch = 2100,
    CancelMatch = 2101,
    MatchSuccess = 2102,
    
    // 游戏相关 (3000-3099)
    GameStart = 3000,
    GameEnd = 3001,
    
    // 移动相关 (3100-3199)
    MoveRequest = 3100,
    MoveSync = 3101,
    
    // 战斗相关 (3200-3299)
    SkillCast = 3200,
    SkillHit = 3201,
    Damage = 3202,
    Death = 3203,
    
    // 状态相关 (3300-3399)
    StateSync = 3300,
    BuffAdd = 3301,
    BuffRemove = 3302,
}
```

### 5.3 Protobuf 定义示例

```protobuf
syntax = "proto3";

message MoveRequest {
    int32 player_id = 1;
    Vector3 target_position = 2;
    float speed = 3;
    int64 timestamp = 4;
}

message Vector3 {
    float x = 1;
    float y = 2;
    float z = 3;
}
```

---

## 6. 部署运维

### 6.1 部署架构

```
负载均衡器（Nginx）
    ↓
    ├── HTTP Server × 3
    └── TCP Server × 3
         ↓
    数据库集群
    ├── PostgreSQL（主从）
    ├── Redis（集群）
    └── MongoDB（副本集）
```

### 6.2 服务器配置

- **HTTP Server**：4核8G，CentOS 8
- **TCP Server**：8核16G，CentOS 8
- **数据库**：8核16G，SSD

### 6.3 配置管理

使用 `appsettings.json` 和环境变量：

```json
{
  "ConnectionStrings": {
    "PostgreSQL": "Host=localhost;Database=cube;Username=user;Password=pass"
  },
  "Redis": {
    "ConnectionString": "localhost:6379"
  },
  "Jwt": {
    "SecretKey": "your-secret-key",
    "Issuer": "CubeServer",
    "Audience": "CubeClient"
  }
}
```

### 6.4 监控告警

- **Prometheus + Grafana**：服务器监控
- **关键指标**：CPU、内存、网络、连接数
- **告警规则**：CPU > 80%、内存 > 90%、连接数异常

### 6.5 日志管理

使用 **Serilog** 记录结构化日志：

```csharp
Log.Information("User {UserId} logged in from {IP}", userId, ip);
Log.Error(ex, "Failed to process order {OrderId}", orderId);
```

---

## 7. 开发指南

### 7.1 开发环境搭建

#### 7.1.1 环境要求

- .NET 8 SDK
- Visual Studio 2022 或 Rider
- PostgreSQL 14+
- Redis 6+
- MongoDB 5+（可选）

#### 7.1.2 安装步骤

```bash
# 1. 安装 .NET 8 SDK
# 下载：https://dotnet.microsoft.com/download

# 2. 安装 PostgreSQL
# Windows: https://www.postgresql.org/download/windows/
# Linux: sudo apt-get install postgresql

# 3. 安装 Redis
# Windows: https://github.com/microsoftarchive/redis/releases
# Linux: sudo apt-get install redis-server

# 4. 克隆项目
git clone <repository-url>
cd server

# 5. 恢复依赖
dotnet restore

# 6. 配置数据库连接
# 编辑 appsettings.json

# 7. 运行数据库迁移
dotnet ef database update

# 8. 运行服务
cd httpserver
dotnet run

# 新终端
cd gameserver
dotnet run
```

### 7.2 代码规范

#### 7.2.1 命名规范

- **类名**：PascalCase（`UserService`）
- **方法名**：PascalCase（`GetUserById`）
- **变量名**：camelCase（`userId`）
- **常量**：UPPER_CASE（`MAX_RETRY_COUNT`）
- **私有字段**：`_camelCase`（`_userRepository`）

#### 7.2.2 代码组织

```csharp
// 1. Using 语句
using System;
using System.Collections.Generic;

// 2. 命名空间
namespace Cube.HttpServer.Services
{
    // 3. 类定义
    public class UserService
    {
        // 4. 私有字段
        private readonly IUserRepository _userRepository;
        
        // 5. 构造函数
        public UserService(IUserRepository userRepository)
        {
            _userRepository = userRepository;
        }
        
        // 6. 公共方法
        public async Task<User> GetUserByIdAsync(int userId)
        {
            // 实现
        }
        
        // 7. 私有方法
        private void ValidateUser(User user)
        {
            // 实现
        }
    }
}
```

#### 7.2.3 异步编程

- 所有 I/O 操作使用 `async/await`
- 方法名以 `Async` 结尾
- 避免 `Task.Result` 和 `Task.Wait()`

```csharp
// ✅ 正确
public async Task<User> GetUserAsync(int id)
{
    return await _repository.GetByIdAsync(id);
}

// ❌ 错误
public User GetUser(int id)
{
    return _repository.GetByIdAsync(id).Result; // 死锁风险
}
```

### 7.3 测试指南

#### 7.3.1 单元测试

使用 **xUnit** 框架：

```csharp
public class UserServiceTests
{
    [Fact]
    public async Task GetUserByIdAsync_ValidId_ReturnsUser()
    {
        // Arrange
        var mockRepo = new Mock<IUserRepository>();
        mockRepo.Setup(r => r.GetByIdAsync(1))
                .ReturnsAsync(new User { Id = 1 });
        
        var service = new UserService(mockRepo.Object);
        
        // Act
        var result = await service.GetUserByIdAsync(1);
        
        // Assert
        Assert.NotNull(result);
        Assert.Equal(1, result.Id);
    }
}
```

#### 7.3.2 集成测试

测试 API 端点：

```csharp
public class AuthControllerTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly HttpClient _client;
    
    public AuthControllerTests(WebApplicationFactory<Program> factory)
    {
        _client = factory.CreateClient();
    }
    
    [Fact]
    public async Task Login_ValidCredentials_ReturnsToken()
    {
        var request = new { username = "test", password = "test123" };
        var response = await _client.PostAsJsonAsync("/api/auth/login", request);
        
        response.EnsureSuccessStatusCode();
        var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
        
        Assert.NotNull(result.AccessToken);
    }
}
```

### 7.4 调试技巧

#### 7.4.1 Visual Studio 调试

- 设置断点
- 查看变量值
- 调用堆栈分析
- 条件断点

#### 7.4.2 日志调试

```csharp
// 使用 Serilog
Log.Debug("Processing request {RequestId}", requestId);
Log.Information("User {UserId} performed action {Action}", userId, action);
Log.Warning("Unusual activity detected: {Activity}", activity);
Log.Error(ex, "Error processing request {RequestId}", requestId);
```

#### 7.4.3 网络抓包

- **Wireshark**：TCP 包分析
- **Postman**：HTTP API 测试
- **Fiddler**：HTTP 调试代理

---

## 附录

### A. 术语表

| 术语 | 说明 |
|-----|------|
| HTTP Server | 基于 HTTP 协议的 Web 服务器 |
| TCP Server | 基于 TCP 协议的游戏服务器 |
| JWT | JSON Web Token，用于身份认证 |
| AOI | Area of Interest，视野范围 |
| ELO | 评分系统 |
| ORM | Object-Relational Mapping |

### B. 参考资源

- [ASP.NET Core 文档](https://docs.microsoft.com/aspnet/core/)
- [Entity Framework Core](https://docs.microsoft.com/ef/core/)
- [Protobuf](https://developers.google.com/protocol-buffers)
- [Redis](https://redis.io/documentation)
- [PostgreSQL](https://www.postgresql.org/docs/)

### C. 文档修订历史

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|---------|--------|
| 1.0 | 2026-01-22 | 创建文档 | System |

---

**文档结束**

本文档将随项目进展持续更新，请定期查阅最新版本。
